{% extends 'base.html' %}

{% block title %}Expert Dashboard{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6" x-data="expertDashboard()">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Pending Questions -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Unanswered Questions</h2>
                <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold" x-text="unansweredQuestions.length + ' pending'"></span>
            </div>
            
            <div class="space-y-4" x-show="unansweredQuestions.length > 0">
                <template x-for="question in unansweredQuestions" :key="question.id">
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="text-xs text-gray-500">Asked by <span x-text="question.farmer_name"></span></span>
                                <p class="text-gray-800 mt-2" x-text="question.content"></p>
                            </div>
                        </div>
                        
                        <div x-show="!question.showAnswerForm" class="mt-3">
                            <button @click="question.showAnswerForm = true" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                Answer this question â†’
                            </button>
                        </div>
                        
                        <div x-show="question.showAnswerForm" class="mt-4 bg-gray-50 p-4 rounded-lg">
                            <textarea x-model="question.answerText" rows="3" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500" placeholder="Type your answer..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button @click="submitAnswer(question)" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                    Submit Answer
                                </button>
                                <button @click="question.showAnswerForm = false" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="unansweredQuestions.length === 0" class="text-center py-12">
                <div class="text-6xl mb-4 opacity-20">âœ…</div>
                <p class="text-gray-500">All questions answered! Great job.</p>
            </div>
        </div>

        <!-- My Suggestions -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">My Suggestions</h2>
                <button @click="showSuggestionForm = !showSuggestionForm" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <span class="mr-2">+</span>New Suggestion
                </button>
            </div>
            
            <!-- Create Suggestion Form -->
            <div x-show="showSuggestionForm" class="mb-6 bg-green-50 p-6 rounded-lg">
                <h3 class="font-bold mb-4">Create New Suggestion</h3>
                <form @submit.prevent="createSuggestion()" class="space-y-4">
                    <input type="text" x-model="newSuggestion.title" placeholder="Title" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500" required>
                    <textarea x-model="newSuggestion.content" rows="4" placeholder="Content..." class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500" required></textarea>
                    <input type="text" x-model="newSuggestion.tags" placeholder="Tags (comma separated)" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500">
                    <div class="flex space-x-2">
                        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Post Suggestion</button>
                        <button type="button" @click="showSuggestionForm = false" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                    </div>
                </form>
            </div>
            
            <div class="space-y-4">
                <template x-for="suggestion in mySuggestions" :key="suggestion.id">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-2" x-text="suggestion.title"></h3>
                        <p class="text-gray-600 text-sm mb-2" x-text="suggestion.content"></p>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded" x-text="suggestion.tags"></span>
                            <span class="text-xs text-gray-500" x-text="new Date(suggestion.created_at).toLocaleDateString()"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Stats -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
            <h3 class="text-sm opacity-90 mb-2">Answers Given</h3>
            <p class="text-4xl font-bold" x-text="answersGiven">0</p>
        </div>

        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
            <h3 class="text-sm opacity-90 mb-2">Suggestions Posted</h3>
            <p class="text-4xl font-bold" x-text="mySuggestions.length">0</p>
        </div>

        <!-- Notifications -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                <span><span class="mr-2">ðŸ””</span>Notifications</span>
                <div class="flex items-center space-x-2">
                    <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full" x-show="unreadNotifications > 0" x-text="unreadNotifications"></span>
                    <button @click="markAllRead()" class="text-xs text-blue-600 hover:underline" x-show="unreadNotifications > 0">Mark all read</button>
                </div>
            </h2>
            <div class="space-y-3 max-h-64 overflow-y-auto">
                <template x-for="notification in notifications" :key="notification.id">
                    <div :class="notification.is_read ? 'bg-gray-50' : 'bg-blue-50'" class="border-l-4 border-blue-500 p-3 rounded text-sm cursor-pointer hover:shadow" @click="markAsRead(notification)">
                        <p class="font-medium text-blue-900" x-text="notification.message"></p>
                        <p class="text-blue-700 text-xs mt-1" x-text="new Date(notification.created_at).toLocaleString()"></p>
                    </div>
                </template>
                <div x-show="notifications.length === 0" class="text-center py-4 text-gray-400">
                    No notifications
                </div>
            </div>
        </div>

        <!-- Chat Inbox -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                <span><span class="mr-2">ðŸ’¬</span>Messages</span>
                <span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full" x-show="unreadMessagesCount > 0" x-text="unreadMessagesCount"></span>
            </h2>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                <template x-for="room in chatRooms" :key="room.id">
                    <div class="p-3 border rounded-lg hover:bg-gray-50 cursor-pointer" @click="openChat(room)">
                        <p class="text-sm" :class="room.unread_count > 0 ? 'font-bold' : 'font-medium'" x-text="room.other_user"></p>
                        <p class="text-xs text-gray-500" x-text="room.last_message?.substring(0, 50) + '...'"></p>
                    </div>
                </template>
                <div x-show="chatRooms.length === 0" class="text-center py-4 text-gray-400">
                    No messages
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Modal -->
<div x-data="chatModal()" @open-chat.window="openChat($event.detail)">
    <div x-show="showChatModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeChat()">
        <div class="bg-white rounded-xl w-full max-w-2xl mx-4 flex flex-col" style="height: 600px;" @click.stop>
            <div class="bg-green-600 text-white p-4 rounded-t-xl flex justify-between items-center">
                <h3 class="font-bold text-lg">Chat with <span x-text="selectedRoom?.other_user"></span></h3>
                <button @click="closeChat()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-3" x-ref="chatMessages">
                <template x-for="msg in chatMessages" :key="msg.id">
                    <div :class="msg.sender === currentUserId ? 'text-right' : 'text-left'">
                        <div :class="msg.sender === currentUserId ? 'bg-green-100 inline-block' : 'bg-gray-100 inline-block'" class="px-4 py-2 rounded-lg max-w-xs">
                            <p class="text-sm" x-text="msg.content"></p>
                            <p class="text-xs text-gray-500 mt-1" x-text="new Date(msg.timestamp).toLocaleTimeString()"></p>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="p-4 border-t">
                <form @submit.prevent="sendChatMessage()" class="flex space-x-2">
                    <input type="text" x-model="newMessage" placeholder="Type your message..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" required>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Send</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        function chatModal() {
            return {
                showChatModal: false,
                selectedRoom: null,
                chatMessages: [],
                newMessage: '',
                currentUserId: {{ request.user.id|default:'null' }},
                pollInterval: null,

                openChat(room) {
                    this.showChatModal = true;
                    this.selectedRoom = room;
                    this.loadChatMessages(room.id);
                    // Start polling
                    this.startPolling();
                },

                closeChat() {
                    this.showChatModal = false;
                    this.stopPolling();
                },

                startPolling() {
                    this.stopPolling();
                    this.pollInterval = setInterval(() => {
                        if (this.selectedRoom) {
                            this.loadChatMessages(this.selectedRoom.id, false);
                        }
                    }, 3000); // Poll every 3 seconds
                },

                stopPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                        this.pollInterval = null;
                    }
                },

                async loadChatMessages(roomId, scrollToBottom = true) {
                    try {
                        const response = await fetch(`/api/notifications/messages/?room=${roomId}`);
                        if (response.ok) {
                            const newMessages = await response.json();
                            // Only update if different to avoid flickering (simplified check)
                            if (newMessages.length !== this.chatMessages.length || newMessages[newMessages.length-1]?.id !== this.chatMessages[this.chatMessages.length-1]?.id) {
                                this.chatMessages = newMessages;
                                if (scrollToBottom) {
                                    this.$nextTick(() => {
                                        this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight;
                                    });
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },
                
                async sendChatMessage() {
                    if (!this.newMessage.trim()) return;
                    
                    try {
                        const response = await fetch('/api/notifications/chat/send/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                room_id: this.selectedRoom.id,
                                content: this.newMessage
                            })
                        });
                        
                        if (response.ok) {
                            this.newMessage = '';
                            await this.loadChatMessages(this.selectedRoom.id);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },
                
                getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
            }
        }
    </script>
</div>

<script>
function expertDashboard() {
    return {
        unansweredQuestions: [],
        mySuggestions: [],
        answersGiven: 0,
        showSuggestionForm: false,
        newSuggestion: {
            title: '',
            content: '',
            tags: ''
        },
        
        init() {
            this.fetchQuestions();
            this.fetchSuggestions();
            this.fetchNotifications();
            this.fetchChatRooms();
        },
        
        notifications: [],
        unreadNotifications: 0,
        chatRooms: [],
        unreadMessagesCount: 0,
        
        async fetchNotifications() {
            try {
                const response = await fetch('/api/notifications/notifications/');
                if (response.ok) {
                    this.notifications = await response.json();
                    this.unreadNotifications = this.notifications.filter(n => !n.is_read).length;
                }
            } catch (error) {
                console.error('Error fetching notifications:', error);
            }
        },
        
        async fetchChatRooms() {
            try {
                const response = await fetch('/api/notifications/chat-rooms/');
                if (response.ok) {
                    this.chatRooms = await response.json();
                    // Calculate unread messages count
                    this.unreadMessagesCount = this.chatRooms.reduce((count, room) => {
                        return count + (room.unread_count || 0);
                    }, 0);
                }
            } catch (error) {
                console.error('Error fetching chat rooms:', error);
            }
        },
        
        async markAsRead(notification) {
            if (notification.is_read) return;
            
            try {
                await fetch(`/api/notifications/notifications/${notification.id}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify({ is_read: true })
                });
                notification.is_read = true;
                this.unreadNotifications--;
                
                if (notification.link) {
                    window.location.href = notification.link;
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        },

        async markAllRead() {
            try {
                await fetch('/api/notifications/notifications/mark_all_read/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    }
                });
                this.notifications.forEach(n => n.is_read = true);
                this.unreadNotifications = 0;
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        },
        
        openChat(room) {
            // Dispatch event to open chat modal
            window.dispatchEvent(new CustomEvent('open-chat', { detail: room }));
        },
        
        async fetchQuestions() {
            try {
                const response = await fetch('/api/experts/questions/?is_answered=false');
                if (response.ok) {
                    this.unansweredQuestions = await response.json();
                    this.unansweredQuestions.forEach(q => q.showAnswerForm = false);
                }
            } catch (error) {
                console.error('Error fetching questions:', error);
            }
        },
        
        async fetchSuggestions() {
            try {
                const response = await fetch('/api/experts/suggestions/');
                if (response.ok) {
                    const allSuggestions = await response.json();
                    // Filter to only show current user's suggestions (simplified)
                    this.mySuggestions = allSuggestions.slice(0, 5);
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        },
        
        async submitAnswer(question) {
            if (!question.answerText || !question.answerText.trim()) {
                alert('Please enter an answer');
                return;
            }
            
            try {
                const response = await fetch('/api/experts/answers/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        question: question.id,
                        content: question.answerText
                    })
                });
                
                if (response.ok) {
                    alert('Answer submitted successfully!');
                    this.answersGiven++;
                    this.fetchQuestions();
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
            }
        },
        
        async createSuggestion() {
            try {
                const response = await fetch('/api/experts/suggestions/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify(this.newSuggestion)
                });
                
                if (response.ok) {
                    alert('Suggestion posted successfully!');
                    this.newSuggestion = { title: '', content: '', tags: '' };
                    this.showSuggestionForm = false;
                    this.fetchSuggestions();
                }
            } catch (error) {
                console.error('Error creating suggestion:', error);
            }
        },
        
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}
</script>
{% endblock %}
